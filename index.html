<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game UAU - Admin (HTML/CSS/JS)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Pixel font (Google) -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --pixel-border: 6px;
      --pixel-shadow: 6px;
      --bg-light: #eaf7f9; /* azul claro do layout */
      --card-blue: #c9e9ee;
    }

    body {
      font-family: "Press Start 2P", monospace;
      background: linear-gradient(90deg,#f7feff 0%, #eaf7f9 100%);
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Pixel box style used across UI */
    .pixel-box {
      background: white;
      border: var(--pixel-border) solid #000;
      box-shadow: var(--pixel-shadow) var(--pixel-shadow) 0 #000;
      border-radius: 4px;
    }

    .pixel-card {
      background: var(--card-blue);
      border: 4px solid #000;
      box-shadow: 6px 6px 0 #000;
    }

    /* Modal overlay centered */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 60;
    }
    .modal-center {
      width: min(900px, 95%);
      max-height: 90vh;
      overflow:auto;
      background: #fff;
      border: 8px solid #000;
      box-shadow: 10px 10px 0 #000;
      padding: 20px;
      border-radius: 4px;
    }

    /* Buttons style */
    .pixel-btn {
      display:inline-block;
      background: #bfeaf0;
      border: 6px solid #000;
      box-shadow: 6px 6px 0 #000;
      padding: 8px 18px;
      cursor:pointer;
      font-family: "Press Start 2P", monospace;
      font-size: 12px;
    }

    /* Small accent tag */
    .tag {
      background:#bfeaf0;
      padding:6px 12px;
      border:4px solid #000;
      box-shadow:4px 4px 0 #000;
      font-size:12px;
      margin-right:8px;
    }

    /* table */
    .ranking-row {
      border: 4px solid #000;
      padding: 12px;
      margin-bottom: 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: #dff3f5;
    }

    /* form inputs pixel */
    .pixel-input{
      background: #fff;
      border:6px solid #000;
      padding:10px;
      width:100%;
      box-shadow: 6px 6px 0 #000;
      margin-bottom:12px;
    }

    /* mobile tweaks */
    @media (max-width: 640px){
      .modal-center{ padding:12px; }
    }

  </style>
</head>
<body class="min-h-screen">

  <div class="max-w-7xl mx-auto py-6 px-4">

    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-center gap-4">
        <div class="pixel-box p-2 inline-flex items-center">
          <div class="w-12 h-12 bg-black mr-2"></div>
          <div class="px-3 py-1 bg-white border-4 border-black">GAME UAU</div>
        </div>
        <div class="text-lg">SISTEMA DE RANKING</div>
        <div class="ml-auto">
          <button id="logoutBtn" class="pixel-btn">SAIR</button>
        </div>
      </div>
    </header>

    <!-- Main Hero -->
    <main>
      <section class="mx-auto mb-8">
        <div class="pixel-box p-8 text-center bg-[--card-blue]">
          <h1 style="font-size:28px">DASHBOARD ADMINISTRATIVO</h1>
        </div>
      </section>

      <!-- Top tags -->
      <div class="mb-6 flex items-center">
        <div id="activeTag" class="tag">TRIMESTRE INATIVO</div>
        <div id="playersCount" class="tag">0 JOGADORES</div>
        <div id="saturdayTag" class="tag">SÁBADO --</div>
      </div>

      <!-- Ações rápidas (cards) -->
      <section class="mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="pixel-card p-6 cursor-pointer" id="card-manage-players">
            <h3>GERENCIAR JOGADORES</h3>
            <p class="mt-2 text-xs">Cadastrar, editar e excluir jogadores</p>
          </div>

          <div class="pixel-card p-6 cursor-pointer" id="card-launch-points">
            <h3>LANÇAR PONTOS</h3>
            <p class="mt-2 text-xs">Cadastrar pontos dos sábados</p>
          </div>

          <div class="pixel-card p-6 cursor-pointer" id="card-annual-ranking">
            <h3>RANKING ANUAL</h3>
            <p class="mt-2 text-xs">Soma dos pontos dos trimestres do ano</p>
          </div>

          <div class="pixel-card p-6 cursor-pointer" id="card-register-player">
            <h3>CADASTRAR JOGADOR</h3>
            <p class="mt-2 text-xs">Adicionar jogador ou administrador</p>
          </div>

          <div class="pixel-card p-6 cursor-pointer flex items-center justify-center" id="card-create-end-game" >
            <h3 id="createEndTitle">NOVO GAME UAU</h3>
          </div>

          <div class="pixel-card p-6 cursor-pointer" id="card-settings">
            <h3>CONFIGURAÇÕES</h3>
            <p class="mt-2 text-xs">Configurar sistema</p>
          </div>
        </div>
      </section>

      <!-- Ranking atual + sidebar -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 pixel-box p-6">
          <h2>RANKING ATUAL</h2>
          <div id="rankingList" class="mt-4">
            <!-- rows injected by JS -->
          </div>

          <div class="mt-4 text-center text-xs">TOTAL: <span id="totalPlayers">0</span> JOGADORES</div>
        </div>

        <aside class="pixel-box p-6">
          <h3>ESTATÍSTICAS</h3>
          <div class="mt-3 text-xs">
            <div>MAIOR PONTUAÇÃO: <span id="statMax">0</span></div>
            <div>MÉDIA GERAL: <span id="statAvg">0</span></div>
            <div>SÁBADOS JOGADOS: <span id="statSábados">0</span></div>
            <div>PRÓXIMO JOGO: <span id="statNextGame">--</span></div>
          </div>

          <div class="mt-6">
            <h4>ADICIONAR JOGADOR</h4>
            <button id="quickRegisterBtn" class="pixel-btn mt-3">CADASTRAR JOGADOR</button>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <!-- Modal container (JS injects content here) -->
  <div id="modal-root"></div>

  <script>
  /***********************
   * Utility & State
   ***********************/
  const STORAGE_KEY = "gameuau_state_v1";

  function formatBR(dateInput){
    if(!dateInput) return "";
    const d = new Date(dateInput);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  function todaySaturdayLabel(){
    // example: display today's date as saturday label (the UI shows sábado/current)
    return formatBR(new Date());
  }

  // default seed data (for demo). It will persist in localStorage after first load.
  const seedState = {
    players: [
      { id: "p1", name: "João Silva", role: "player", createdAt: new Date().toISOString() },
      { id: "p2", name: "Maria Santos", role: "player", createdAt: new Date().toISOString() },
      { id: "p3", name: "Carlos Oliveira", role: "player", createdAt: new Date().toISOString() },
      { id: "p4", name: "Ana Costa", role: "player", createdAt: new Date().toISOString() },
      { id: "p5", name: "Pedro Souza", role: "player", createdAt: new Date().toISOString() },
      { id: "admin1", name: "Admin Demo", role: "admin", createdAt: new Date().toISOString() }
    ],
    // games: array newest first
    games: [
      {
        id: "g1",
        year: new Date().getFullYear(),
        trimester: 1,
        startedAt: new Date().toISOString(),
        endedAt: null,
        playersPoints: { p1:1250, p2:1100, p3:950, p4:800, p5:750 }
      }
    ],
    activeGameId: "g1"
  };

  function loadState(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(seedState, null, 2));
        return JSON.parse(JSON.stringify(seedState));
      }
      return JSON.parse(raw);
    } catch(e){
      console.error("loadState err", e);
      return JSON.parse(JSON.stringify(seedState));
    }
  }

  function saveState(s){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s, null, 2));
  }

  let state = loadState();

  /***********************
   * Core model functions
   ***********************/
  function reopenUI(){
    renderTopTags();
    renderRanking();
    renderStats();
  }

  function createPlayer({name, role="player", email=null}){
    const id = "p" + Date.now();
    const player = { id, name, role, email, createdAt: new Date().toISOString() };
    state.players.push(player);
    saveState(state);
    reopenUI();
    return player;
  }

  function createGame({year, trimester}){
    if(state.activeGameId) throw new Error("Já existe um trimestre ativo. Encerre antes de criar outro.");
    const id = "g" + Date.now();
    const g = { id, year, trimester, startedAt: new Date().toISOString(), endedAt: null, playersPoints: {} };
    state.games.unshift(g);
    state.activeGameId = id;
    saveState(state);
    reopenUI();
    return g;
  }

  function endGame(gameId){
    state.games = state.games.map(g => {
      if(g.id === gameId) return {...g, endedAt: new Date().toISOString()};
      return g;
    });
    if(state.activeGameId === gameId) state.activeGameId = null;
    saveState(state);
    reopenUI();
  }

  function addPoints(gameId, playerId, points){
    state.games = state.games.map(g => {
      if(g.id !== gameId) return g;
      const copy = {...g, playersPoints: {...g.playersPoints}};
      copy.playersPoints[playerId] = (copy.playersPoints[playerId] || 0) + Number(points);
      return copy;
    });
    saveState(state);
    reopenUI();
  }

  function computeAnnualRanking(year){
    const map = {}; // playerId -> total
    state.games.forEach(g => {
      const gameYear = new Date(g.startedAt).getFullYear();
      if(gameYear !== year) return;
      Object.entries(g.playersPoints || {}).forEach(([pid, pts]) => {
        map[pid] = (map[pid] || 0) + Number(pts || 0);
      });
    });
    const arr = Object.entries(map).map(([id, points]) => ({ id, points }));
    arr.sort((a,b)=> b.points - a.points);
    return arr;
  }

  /***********************
   * UI Rendering
   ***********************/
  const playersCountEl = document.getElementById("playersCount");
  const activeTagEl = document.getElementById("activeTag");
  const saturdayTagEl = document.getElementById("saturdayTag");
  const createEndTitleEl = document.getElementById("createEndTitle");
  const rankingListEl = document.getElementById("rankingList");
  const totalPlayersEl = document.getElementById("totalPlayers");
  const statMaxEl = document.getElementById("statMax");
  const statAvgEl = document.getElementById("statAvg");
  const statSabadosEl = document.getElementById("statSábados");
  const statNextGameEl = document.getElementById("statNextGame");

  function renderTopTags(){
    playersCountEl.textContent = state.players.length + " JOGADORES";
    if(state.activeGameId){
      activeTagEl.textContent = "TRIMESTRE ATIVO";
      createEndTitleEl.textContent = "ENCERRAR GAME";
    } else {
      activeTagEl.textContent = "TRIMESTRE INATIVO";
      createEndTitleEl.textContent = "NOVO GAME UAU";
    }
    saturdayTagEl.textContent = "SÁBADO " + todaySaturdayLabel();
  }

  function renderRanking(){
    rankingListEl.innerHTML = "";
    const activeGame = state.games.find(g => g.id === state.activeGameId) || state.games[0] || null;
    if(!activeGame){
      rankingListEl.innerHTML = "<div class='text-sm'>Nenhum trimestre disponível</div>";
      totalPlayersEl.textContent = "0";
      return;
    }
    // build ranking rows
    // compute ordering by points desc
    const pts = activeGame.playersPoints || {};
    const arr = state.players.map(p => {
      return { id: p.id, name: p.name, points: pts[p.id] || 0 };
    });
    arr.sort((a,b)=> b.points - a.points);

    arr.forEach((r, idx)=>{
      const row = document.createElement("div");
      row.className = "ranking-row pixel-box";
      row.innerHTML = `
        <div class="flex items-center gap-3">
          <div style="width:30px;text-align:center">${ idx < 3 ? (idx+1 + "º") : ( (r.points>0) ? (idx+1+"º") : (idx+1+"º"))}</div>
          <div>${r.name}</div>
        </div>
        <div class="font-bold">${r.points.toLocaleString('pt-BR')}</div>
      `;
      rankingListEl.appendChild(row);
    });

    totalPlayersEl.textContent = state.players.length;
  }

  function renderStats(){
    // compute stats for current year (or active game)
    const activeGame = state.games.find(g => g.id === state.activeGameId) || state.games[0] || null;
    if(!activeGame){
      statMaxEl.textContent = "0";
      statAvgEl.textContent = "0";
      statSabadosEl.textContent = "0";
      statNextGameEl.textContent = "--";
      return;
    }
    const pts = Object.values(activeGame.playersPoints || {});
    const max = pts.length ? Math.max(...pts) : 0;
    const avg = pts.length ? Math.round(pts.reduce((a,b)=>a+b,0)/pts.length) : 0;
    statMaxEl.textContent = max.toLocaleString('pt-BR');
    statAvgEl.textContent = avg.toLocaleString('pt-BR');
    // sábados jogados: we store number as sample here using points as hint: we use game's config? for demo:
    statSabadosEl.textContent = Object.keys(activeGame.playersPoints || {}).length + "/15";
    statNextGameEl.textContent = "SÁBADO " + formatBR(new Date());
  }

  /***********************
   * Modal logic
   ***********************/
  const modalRoot = document.getElementById("modal-root");
  let currentModal = null;

  function openModal(type, payload){
    closeModal(); // ensure single
    currentModal = { type, payload };
    document.body.style.overflow = "hidden";
    const overlay = document.createElement("div");
    overlay.className = "modal-overlay";
    overlay.id = "modal-overlay";
    overlay.addEventListener("click", closeModal);

    const center = document.createElement("div");
    center.className = "modal-center";
    center.addEventListener("click", e => e.stopPropagation());

    // build content
    if(type === "player"){
      center.innerHTML = playerModalHtml();
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
      attachPlayerModalHandlers();
    } else if(type === "createGame"){
      center.innerHTML = createGameModalHtml();
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
      attachCreateGameHandlers();
    } else if(type === "endGame"){
      center.innerHTML = endGameModalHtml();
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
      attachEndGameHandlers(payload);
    } else if(type === "annualRanking"){
      center.innerHTML = annualRankingModalHtml();
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
      attachAnnualRankingHandlers();
    } else if(type === "managePlayers"){
      center.innerHTML = managePlayersModalHtml();
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
      attachManagePlayersHandlers();
    } else if(type === "launchPoints"){
      center.innerHTML = launchPointsModalHtml();
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
      attachLaunchPointsHandlers();
    } else {
      center.innerHTML = "<div>Em desenvolvimento</div>";
      overlay.appendChild(center);
      modalRoot.appendChild(overlay);
    }
  }

  function closeModal(){
    const overlay = document.getElementById("modal-overlay");
    if(overlay) overlay.remove();
    currentModal = null;
    document.body.style.overflow = "";
  }

  /***********************
   * Modal templates + handlers
   ***********************/
  function playerModalHtml(){
    return `
      <h2>CADASTRAR JOGADOR / ADMIN</h2>
      <form id="form-player" class="mt-4">
        <label>Nome</label>
        <input id="player-name" class="pixel-input" placeholder="Nome completo" required />
        <label>Email (opcional)</label>
        <input id="player-email" class="pixel-input" placeholder="email@exemplo.com" />
        <label>Perfil</label>
        <select id="player-role" class="pixel-input">
          <option value="player">Jogador</option>
          <option value="admin">Administrador</option>
        </select>
        <div class="flex gap-3">
          <button type="submit" class="pixel-btn">CADASTRAR</button>
          <button type="button" id="cancel-player" class="pixel-btn">CANCELAR</button>
        </div>
      </form>
    `;
  }

  function attachPlayerModalHandlers(){
    const form = document.getElementById("form-player");
    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      const name = document.getElementById("player-name").value.trim();
      const email = document.getElementById("player-email").value.trim();
      const role = document.getElementById("player-role").value;
      if(!name) return alert("Digite o nome");
      createPlayer({name, role, email: email || null});
      alert("Jogador cadastrado com sucesso!");
      closeModal();
    });
    document.getElementById("cancel-player").addEventListener("click", closeModal);
  }

  function createGameModalHtml(){
    const year = new Date().getFullYear();
    return `
      <h2>NOVO GAME UAU</h2>
      <form id="form-create-game" class="mt-4">
        <label>Trimestre</label>
        <select id="create-trim" class="pixel-input">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
        <label>Ano</label>
        <input id="create-year" type="number" class="pixel-input" value="${year}" />
        <div class="flex gap-3">
          <button class="pixel-btn" type="submit">CRIAR</button>
          <button type="button" id="cancel-create" class="pixel-btn">CANCELAR</button>
        </div>
      </form>
    `;
  }

  function attachCreateGameHandlers(){
    document.getElementById("form-create-game").addEventListener("submit", (e)=>{
      e.preventDefault();
      const trimester = Number(document.getElementById("create-trim").value);
      const year = Number(document.getElementById("create-year").value);
      try {
        createGame({year, trimester});
        alert("Trimestre criado!");
        closeModal();
      } catch(err){
        alert(err.message);
      }
    });
    document.getElementById("cancel-create").addEventListener("click", closeModal);
  }

  function endGameModalHtml(){
    return `
      <h2>ENCERRAR TRIMESTRE</h2>
      <p>Deseja encerrar o trimestre em andamento?</p>
      <div class="flex gap-3 mt-4">
        <button id="confirm-end" class="pixel-btn">SIM, ENCERRAR</button>
        <button id="cancel-end" class="pixel-btn">CANCELAR</button>
      </div>
    `;
  }

  function attachEndGameHandlers(payload){
    document.getElementById("confirm-end").addEventListener("click", ()=>{
      const id = state.activeGameId;
      if(!id) { alert("Nenhum trimestre ativo."); return; }
      endGame(id);
      alert("Trimestre encerrado.");
      closeModal();
    });
    document.getElementById("cancel-end").addEventListener("click", closeModal);
  }

  function annualRankingModalHtml(){
    const rank = computeAnnualRanking(new Date().getFullYear());
    const rows = rank.map((r, i)=> {
      const player = state.players.find(p => p.id === r.id);
      const name = player ? player.name : "Desconhecido";
      return `<div class="flex justify-between py-2 border-b"><div>${i+1}. ${name}</div><div>${r.points.toLocaleString('pt-BR')}</div></div>`;
    }).join("") || "<div>Nenhum registro</div>";
    return `<h2>RANKING ANUAL - ${new Date().getFullYear()}</h2><div class="mt-4">${rows}</div><div class="mt-4"><button id="close-annual" class="pixel-btn">FECHAR</button></div>`;
  }

  function attachAnnualRankingHandlers(){
    document.getElementById("close-annual").addEventListener("click", closeModal);
  }

  function managePlayersModalHtml(){
    const rows = state.players.map(p => `
      <div class="flex justify-between items-center py-2 border-b">
        <div>
          <div>${p.name}</div>
          <div class="text-xs">${p.role}</div>
        </div>
        <div>
          <button class="pixel-btn btn-edit" data-id="${p.id}">EDIT</button>
          <button class="pixel-btn btn-del" data-id="${p.id}">DEL</button>
        </div>
      </div>
    `).join("");
    return `<h2>GERENCIAR JOGADORES</h2><div class="mt-4">${rows}</div><div class="mt-4"><button id="close-manage" class="pixel-btn">FECHAR</button></div>`;
  }

  function attachManagePlayersHandlers(){
    document.querySelectorAll(".btn-del").forEach(btn=>{
      btn.addEventListener("click", e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm("Excluir jogador?")) return;
        state.players = state.players.filter(p=>p.id !== id);
        // also remove from points
        state.games.forEach(g => { if(g.playersPoints && g.playersPoints[id]) delete g.playersPoints[id]; });
        saveState(state);
        alert("Excluído");
        closeModal();
        reopenUI();
      });
    });
    document.getElementById("close-manage").addEventListener("click", closeModal);
  }

  function launchPointsModalHtml(){
    const activeGame = state.games.find(g => g.id === state.activeGameId) || null;
    if(!activeGame) return `<h2>LANÇAR PONTOS</h2><div class="mt-4">Nenhum trimestre ativo.</div><div class="mt-4"><button id="close-launch" class="pixel-btn">FECHAR</button></div>`;
    const playerOptions = state.players.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
    return `
      <h2>LANÇAR PONTOS - TRIMESTRE ATIVO</h2>
      <form id="form-points" class="mt-4">
        <label>Jogador</label>
        <select id="points-player" class="pixel-input">${playerOptions}</select>
        <label>Pontos (ex: 250)</label>
        <input id="points-value" class="pixel-input" type="number" value="0" />
        <div class="flex gap-3">
          <button class="pixel-btn" type="submit">ADICIONAR</button>
          <button type="button" id="cancel-launch" class="pixel-btn">CANCELAR</button>
        </div>
      </form>
    `;
  }

  function attachLaunchPointsHandlers(){
    const activeGame = state.games.find(g => g.id === state.activeGameId) || null;
    if(!activeGame){
      document.getElementById("close-launch").addEventListener("click", closeModal);
      return;
    }
    document.getElementById("form-points").addEventListener("submit", (e)=>{
      e.preventDefault();
      const pid = document.getElementById("points-player").value;
      const pts = Number(document.getElementById("points-value").value) || 0;
      if(!pid) return alert("Selecione jogador");
      addPoints(activeGame.id, pid, pts);
      alert("Pontos adicionados");
      closeModal();
    });
    document.getElementById("cancel-launch").addEventListener("click", closeModal);
  }

  /***********************
   * wiring up cards/buttons
   ***********************/
  document.getElementById("card-register-player").addEventListener("click", ()=> openModal("player"));
  document.getElementById("quickRegisterBtn").addEventListener("click", ()=> openModal("player"));
  document.getElementById("card-manage-players").addEventListener("click", ()=> openModal("managePlayers"));
  document.getElementById("card-annual-ranking").addEventListener("click", ()=> openModal("annualRanking"));
  document.getElementById("card-launch-points").addEventListener("click", ()=> openModal("launchPoints"));
  document.getElementById("card-settings").addEventListener("click", ()=> alert("Configurações - ainda sem backend"));

  document.getElementById("card-create-end-game").addEventListener("click", ()=>{
    if(state.activeGameId) openModal("endGame");
    else openModal("createGame");
  });

  // logout demo
  document.getElementById("logoutBtn").addEventListener("click", ()=> alert("Logout (demo)"));

  // make sure modal openers call right handlers
  // dynamic attach for modal type 'launchPoints' route to template name "launchPoints"
  function attachHandlersForModalType(type){
    // not used now because we pass explicit attachers
  }

  /***********************
   * Initial render
   ***********************/
  function computeAnnualRanking(){
    return (function(year){
      const map = {};
      state.games.forEach(g=>{
        const gy = new Date(g.startedAt).getFullYear();
        if(gy !== year) return;
        Object.entries(g.playersPoints || {}).forEach(([pid, pts])=>{
          map[pid] = (map[pid] || 0) + Number(pts || 0);
        });
      });
      const arr = Object.entries(map).map(([id, points])=>({id, points}));
      arr.sort((a,b)=> b.points - a.points);
      return arr;
    })(new Date().getFullYear());
  }

  // expose helper computeAnnualRanking globally used in modal template
  window.computeAnnualRanking = function(year = new Date().getFullYear()){
    const map = {};
    state.games.forEach(g=>{
      const gy = new Date(g.startedAt).getFullYear();
      if(gy !== year) return;
      Object.entries(g.playersPoints || {}).forEach(([pid, pts])=>{
        map[pid] = (map[pid] || 0) + Number(pts || 0);
      });
    });
    return Object.entries(map).map(([id, points])=>({ id, points })).sort((a,b)=> b.points - a.points);
  };

  // helper used in templates
  function computeAnnualRankingForTemplate(year = new Date().getFullYear()){
    const arr = window.computeAnnualRanking(year);
    return arr;
  }

  // renderData used at start
  reopenUI();

  // Also export some functions to console for quick demo use
  window.__gameuau = {
    state,
    createPlayer,
    createGame,
    endGame,
    addPoints,
    saveState,
    loadState
  };

  // When modal root receives a new child, the attach functions above will wire events.
  // initial sample: nothing to do

  </script>

</body>
</html>
